<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ -æ”¾é€å§”å“¡ä¼š</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css"/>
  <script src="skript.js" defer></script>

  <style>
    .ux-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.2); display: none; align-items: center; justify-content: center; z-index: 999; }
    .ux-overlay.show { display: flex; }
    .ux-modal { background: #fff; padding: 16px; border-radius: 10px; width: min(420px, 92%); box-shadow: 0 8px 24px rgba(0,0,0,.15); text-align: left; }
    .ux-row { display: flex; gap: 8px; margin-top: 8px; }
    .ux-modal input[type="text"], .ux-modal input[type="password"] { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    .ux-modal button { padding: 8px 12px; cursor: pointer; }

    .ux-stop-card { border: 2px solid #f5c2c7; background: #fff; border-radius: 10px; padding: 16px; margin-top: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .ux-stop-title { color: #d00000; font-weight: bold; font-size: 18px; margin-bottom: 6px; text-align: center; }
    .ux-stop-reason { color: #111; font-size: 14px; text-align: center; }

    .ux-maint-overlay { position: fixed; inset: 0; background: rgba(255,255,255,.85); display: none; align-items:center; justify-content:center; z-index: 1000; }
    .ux-maint-overlay.show { display: flex; }
    .ux-maint-box { border: 2px dashed #d00000; background:#fff; padding: 20px 24px; border-radius: 12px; text-align:center; }
    .ux-maint-box h2 { color:#d00000; margin:0 0 4px; }
    .ux-maint-box p { margin:0; color:#333; }

    .ux-hidden { display: none !important; }
    #token-info { margin-top: 6px; font-size: 14px; opacity: .85; }

    /* ç®¡ç†è€…ãƒœã‚¿ãƒ³ã‚’å³ä¸Šå›ºå®š */
    .admin-button {
      position: fixed !important;
      top: 12px;
      right: 12px;
      z-index: 1100;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚’ç”»é¢ä¸­å¤®ã« */
    #mainContainer {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: min(92vw, 520px);
      max-height: 90vh;
      overflow: auto;
    }
  
  /* My Page link (top-right) */
  .mypage-link{position:fixed;top:12px;right:12px;z-index:1100;display:inline-flex;gap:8px;align-items:center;background:#111827;color:#fff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #374151;box-shadow:0 6px 16px rgba(0,0,0,.25);font-size:14px}
  .mypage-link img{width:20px;height:20px;border-radius:50%;object-fit:cover}
.theme-link{right:150px;}
  @media (max-width:520px){.mypage-link{padding:8px 12px}}
  /* push admin button down a bit so both are visible */
  .admin-button{top:56px !important;}
</style>
</head>

<body>
  <a id="mypage-link" class="mypage-link" href="/mypage"><img src="/img/mypage.png" alt="ãƒã‚¤ãƒšãƒ¼ã‚¸"><span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span></a>
<a id="theme-link" class="mypage-link theme-link" href="/theme" style="display:none;"><span>ğŸ§ ãƒ†ãƒ¼ãƒæŠ•ç¥¨</span></a>

  <!-- ç®¡ç†è€…ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šå›ºå®šï¼‰ -->
  <button class="admin-button" onclick="goAdmin()">ç®¡ç†è€…ç”¨</button>

  <!-- ç”»é¢ä¸­å¤®ã«é…ç½®ã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="container" id="mainContainer">
    <h1 id="frontendTitle" style="margin-bottom:10px;">â™¬æ›²ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹</h1>
    <div id="themeBanner" class="theme-banner" style="display:none;">
      <div class="theme-banner-head">
        <div class="theme-banner-title" id="themeTitleText"></div>
        <div class="theme-banner-period" id="themePeriodText"></div>
      </div>
      <div class="theme-banner-desc" id="themeDescText"></div>
      <div class="theme-banner-actions">
        <a class="theme-vote-btn" id="themeVoteBtn" href="/theme">æŠ•ç¥¨ã™ã‚‹</a>
        <span class="theme-banner-note">ã‚¤ãƒ™ãƒ³ãƒˆæœŸé–“ä¸­ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€Œãƒ†ãƒ¼ãƒå¿œå‹Ÿã€ã¨ã—ã¦é›†è¨ˆã•ã‚Œã¾ã™</span>
      </div>
    </div>


    <!-- æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆæ—¢å­˜ï¼‰ + ã‚½ãƒ¼ãƒˆï¼ˆæœ€å°UIè¿½åŠ ï¼‰ -->
    <div id="modeToggle" style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
      <div>
        <button id="modeSong" onclick="setSearchMode('song');" style="margin-right:5px;">æ›²å(ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ)ã§æ¤œç´¢</button>
        <button id="modeArtist" onclick="setSearchMode('artist');">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‹ã‚‰æ¤œç´¢</button>
      </div>
      <label style="font-size:14px;">
        ä¸¦ã³æ›¿ãˆ:
        <select id="searchSort" style="padding:4px; border-radius:6px;">
          <option value="relevance">ãƒ™ã‚¹ãƒˆãƒãƒƒãƒ</option>
          <option value="release_desc">æ–°ã—ã„é †</option>
          <option value="release_asc">å¤ã„é †</option>
          <option value="name_asc">æ›²å Aâ†’Z</option>
          <option value="artist_asc">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ Aâ†’Z</option>
        </select>
      </label>
    </div>

    <!-- é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ—¢å­˜IDã‚’ãã®ã¾ã¾ï¼‰ -->
    <form id="requestForm" action="/submit" method="post" onsubmit="handleSubmit(event)">
      <div class="input-container">
        <input type="text" id="songName" name="response" placeholder="æ›²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" oninput="searchSongs()">
        <button type="button" class="input-clear-btn" onclick="clearInput('songName')">Ã—</button>
      </div>

      <div class="input-container" id="artistInputContainer">
        <input type="text" id="artistName" name="artist" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" oninput="searchSongs()">
        <button type="button" class="input-clear-btn" onclick="clearInput('artistName')">Ã—</button>
      </div>

      <div id="reSearchSongMode" style="margin:10px 0; display:block;">
        <button type="button" onclick="reSearch()">å†æ¤œç´¢</button>
      </div>
      <div id="reSearchArtistMode" style="margin:10px 0; display:none;">
        <button type="button" onclick="reSearch()">å†æ¤œç´¢</button>
      </div>

      <div id="suggestions"></div>

      <!-- â–¼ æ–°ãƒ»æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰å‹ æ¤œç´¢çµæœï¼ˆæœ€å¤§5æšè¡¨ç¤ºï¼‰ -->
      <div id="resultsCarousel" class="carousel-wrap ux-hidden" aria-label="æ¤œç´¢çµæœ">
        <div class="carousel-track" id="carouselTrack"></div>
      </div>

      <!-- â–¼ å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆä¸Š:å†ç”Ÿ+ã‚·ãƒ¼ã‚¯, ä¸‹:éŸ³é‡ï¼‰ -->
      <div id="playerControls" class="player-controls ux-hidden">
        <div class="player-top">
          <button type="button" id="playPauseBtn" aria-label="å†ç”Ÿ/ä¸€æ™‚åœæ­¢" class="noselect">â–¶</button>
          <input type="range" id="seekBar" min="0" max="1000" step="1" value="0" aria-label="ã‚·ãƒ¼ã‚¯ãƒãƒ¼" class="noselect">
          <span id="timeLabel" class="time-label noselect">0:00 / 0:00</span>
        </div>
        <div class="player-bottom">
          <button type="button" id="volumeBtn" aria-label="ãƒŸãƒ¥ãƒ¼ãƒˆ/è§£é™¤" class="noselect">ğŸ”Š</button>
          <input type="range" id="volumeBar" min="1" max="100" step="1" value="40" class="volume-slider noselect" aria-label="éŸ³é‡">
        </div>
      </div>

      <div id="selectedArtist"></div>
      <div id="selectedLabel"></div>
      <div id="selectedSong"></div>

      <!-- hiddenï¼ˆé¸æŠæ›²ã®æƒ…å ±ï¼‰ -->
      <input type="hidden" id="appleMusicUrlHidden" name="appleMusicUrl">
      <input type="hidden" id="artworkUrlHidden" name="artworkUrl">
      <input type="hidden" id="previewUrlHidden" name="previewUrl">

      <button id="submitButton" type="submit">é€ä¿¡</button>
      <div id="token-info">-</div>
      <div id="token-countdown" class="muted" style="font-size:12px;margin-top:2px;"></div>

      <!-- å‹Ÿé›†åœæ­¢ã‚«ãƒ¼ãƒ‰ã®æŒ¿å…¥å…ˆ -->
      <div id="stopCardHost"></div>
    </form>
  </div>

  <!-- åˆå›ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="ux-overlay" id="welcomeOverlay" aria-hidden="true">
    <div class="ux-modal">
      <h3 style="margin:0 0 6px;">ã‚ˆã†ã“ãï¼</h3>
      <p style="margin:0 0 8px;">ãƒ¦ãƒ¼ã‚¶ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦åˆå›ç™»éŒ²ã—ã¦ãã ã•ã„ï¼ˆç«¯æœ«ã”ã¨ã«1ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã€‚</p>
      <div class="ux-row"><input id="usernameInput" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒãƒ¼ãƒ "></div>
      <details style="margin-top:6px;">
        <summary>ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</summary>
        <div class="ux-row"><input id="adminPassInput" type="password" placeholder="ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"></div>
        <div id="adminTryInfo" style="margin-top:6px; font-size:13px; color:#555;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ®‹ã‚Š: 3 å›</div>
      </details>
      <div class="ux-row" style="justify-content:flex-end;"><button id="registerBtn" type="button">ç™»éŒ²</button></div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ³ãƒ†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="ux-maint-overlay" id="maintenanceOverlay">
    <div class="ux-maint-box">
      <h2>ç¾åœ¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã§ã™</h2>
      <p>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>
  </div>

  <!-- â–¼ éè¡¨ç¤ºã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ï¼ˆæ—§UIã®ãƒœã‚¿ãƒ³/ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã ã‘ã§æ“ä½œï¼‰ -->
  <audio id="amPreviewAudio" preload="none" style="display:none;"></audio>
<audio id="previewAudio" preload="none" style="display:none;" crossorigin="anonymous"></audio>
  <!-- â–² -->

  <script>
    // ------- ç®¡ç†è€…ãƒœã‚¿ãƒ³ï¼ˆæ¨©é™ãŒã‚ã‚Œã°å³ /adminï¼‰ -------
    async function goAdmin() {
      try {
        const me = await fetch('/me').then(r=>r.json());
        if ((me?.loggedIn && me.user?.role === 'admin') || me?.adminSession === true) {
          location.href = '/admin';
        } else {
          alert('ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        }
      } catch {
        alert('çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    }

    // ------- è¨­å®šåæ˜ ï¼ˆãƒ¡ãƒ³ãƒ†/å‹Ÿé›†ï¼‰ -------
    async function applySettingsToUI() {
      try {
        const data = await (await fetch("/settings")).json();

        const maint = document.getElementById("maintenanceOverlay");
        if (maint) { if (data.maintenance) maint.classList.add("show"); else maint.classList.remove("show"); }

        const titleEl = document.getElementById("frontendTitle");
        const modeToggle = document.getElementById("modeToggle");
        const form = document.getElementById("requestForm");
        const stopHost = document.getElementById("stopCardHost");

        if (!data.recruiting) {
          if (titleEl) { titleEl.textContent = "ç¾åœ¨å‹Ÿé›†ã‚’çµ‚äº†ã—ã¦ã„ã¾ã™"; titleEl.style.color = "#d00000"; }
          if (modeToggle) modeToggle.classList.add("ux-hidden");
          if (form) Array.from(form.querySelectorAll("input,button,select,textarea")).forEach(el => el.disabled = true);
          if (stopHost) {
            stopHost.innerHTML = `
              <div class="ux-stop-card">
                <div class="ux-stop-title">ç¾åœ¨å‹Ÿé›†ã‚’çµ‚äº†ã—ã¦ã„ã¾ã™</div>
                <div class="ux-stop-reason">${data.reason ? ("ç†ç”±: " + String(data.reason)) : ""}</div>
              </div>`;
          }
        } else {
          titleEl && (titleEl.style.color = "");
          modeToggle && modeToggle.classList.remove("ux-hidden");
          if (form) Array.from(form.querySelectorAll("input,button,select,textarea")).forEach(el => el.disabled = false);
          stopHost && (stopHost.innerHTML = "");
        }

        if (data.frontendTitle) document.getElementById("frontendTitle").textContent = data.frontendTitle;
      } catch (e) {
        console.error("è¨­å®šåæ˜ ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    // ------- ãƒ¦ãƒ¼ã‚¶/ãƒˆãƒ¼ã‚¯ãƒ³ -------
    async function fetchMe() {
      try { const r = await fetch('/me'); return await r.json(); }
      catch { return { loggedIn:false }; }
    }
    function updateTokenInfo(me) {
      const el = document.getElementById('token-info');
      if (!el) return;
      if (!me || !me.loggedIn) { el.textContent = 'æœªç™»éŒ²ã§ã™ã€‚'; return; }
      const name = me.user?.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
      if (me.user?.role === 'admin') {
        el.textContent = `${name} ã•ã‚“ ä»Šæœˆã®æ®‹ã‚Šãƒˆãƒ¼ã‚¯ãƒ³: ç„¡åˆ¶é™ï¼ˆç®¡ç†è€…ï¼‰`;
      } else {
        el.textContent = `${name} ã•ã‚“ã®ä»Šæœˆã®æ®‹ã‚Šãƒˆãƒ¼ã‚¯ãƒ³: ${me.user?.tokens ?? 0}`;
      }
    }
    async function ensureRegistered() {
      const me = await fetchMe();
      if (!me.loggedIn) { document.getElementById('welcomeOverlay')?.classList.add('show'); }
      else { updateTokenInfo(me); }
    }

    // ------- ç®¡ç†è€…ãƒ‘ã‚¹æ®‹å›æ•°è¡¨ç¤º -------
    async function refreshAdminTryInfo() {
      try {
        const r = await fetch('/auth/status');
        const s = await r.json();
        const left = typeof s.adminRegRemaining === 'number' ? s.adminRegRemaining : 3;
        const el = document.getElementById('adminTryInfo');
        if (el) el.textContent = `ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ®‹ã‚Š: ${left} å›`;
        return left;
      } catch {
        const el = document.getElementById('adminTryInfo');
        if (el) el.textContent = `ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ®‹ã‚Š: 3 å›`;
        return 3;
      }
    }

    // ------- ç™»éŒ²ï¼ˆç®¡ç†è€…ãƒ‘ã‚¹ãŒæ­£ã—ã‘ã‚Œã°å³ admin / èª¤ã‚Šã¯ç™»éŒ²ã›ãšå†å…¥åŠ›ï¼‰ -------
    async function registerNow() {
      const uiName = document.getElementById('usernameInput');
      const uiPass = document.getElementById('adminPassInput');
      const username = (uiName?.value ?? '').trim() || 'Guest';
      const adminPassword = (uiPass?.value ?? '').trim();

      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ username, adminPassword: adminPassword || undefined })
        });
        const data = await res.json();

        if (data.ok) {
          const roleJa = data.role === 'admin' ? 'ç®¡ç†è€…' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
          const nameForAlert = data.username || username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
          alert(`âœ…${roleJa}ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ\n${nameForAlert} ã•ã‚“ã‚ˆã†ã“ãï¼`);
          document.getElementById('welcomeOverlay')?.classList.remove('show');
          const me = await fetchMe();
          updateTokenInfo(me);
          return;
        }

        if (data.reason === 'bad_admin_password') {
          const left = (typeof data.remaining === 'number') ? data.remaining : 0;
          alert(`ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚æ®‹ã‚Š ${left} å›`);
          if (uiPass) { uiPass.value = ''; uiPass.focus(); }
          await refreshAdminTryInfo();
          return;
        }
        if (data.reason === 'locked') {
          alert('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è©¦è¡Œä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¬„ã‚’ç©ºã«ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
          if (uiPass) { uiPass.value = ''; uiPass.blur(); }
          await refreshAdminTryInfo();
          return;
        }
        alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      } catch (e) {
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    // ------- æ—§UIã§æ–°ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ã†ï¼šãƒã‚¤ãƒ³ãƒ‰å‡¦ç† -------
    const audioEl = document.getElementById('amPreviewAudio');
    let lastVolume = 0.8; audioEl.volume = lastVolume;

    function proxied(url) {
      return `/preview?url=${encodeURIComponent(url)}`;
    }

    // æ›²é¸æŠå¾Œã« hidden ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’å–ã‚Šå‡ºã—ã¦ audio ã«è¨­å®š
    function setLegacyPreviewFromHidden() {
      const pv = document.getElementById('previewUrlHidden')?.value?.trim();
      if (!pv) { audioEl.pause(); audioEl.removeAttribute('src'); return; }
      const src = proxied(pv);
      if (audioEl.src !== location.origin + src && audioEl.src !== src) {
        audioEl.src = src;
        try { audioEl.load(); } catch {}
      }
    }

    // æ—§UIã®å†ç”Ÿãƒœã‚¿ãƒ³ï¼†éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’æ¤œå‡ºã—ã¦ãƒã‚¤ãƒ³ãƒ‰
    function wireLegacyPlayerControls() {
      const host = document.getElementById('selectedSong') || document.getElementById('selectedLabel') || document;
      if (!host) return;

      // å†ç”Ÿãƒœã‚¿ãƒ³å€™è£œï¼ˆæ–‡å­—ãŒã€Œå†ç”Ÿã€ã‚’å«ã‚€ã€ã¾ãŸã¯â–¶ç³»ã€ã¾ãŸã¯ãã‚Œã£ã½ã„ã‚¯ãƒ©ã‚¹ï¼‰
      const playBtn =
        host.querySelector('button.play, button.play-btn, button#playButton, button[title*="å†ç”Ÿ"], button[aria-label*="å†ç”Ÿ"], button') ||
        null;

      // éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€™è£œï¼ˆrangeã§ 0ã€œ1 / step 0.01 ã£ã½ã„ã‚‚ã®ã‚’å„ªå…ˆï¼‰
      let vol = null;
      const ranges = host.querySelectorAll('input[type="range"]');
      for (const r of ranges) {
        const max = (r.getAttribute('max') || '').trim();
        const step = (r.getAttribute('step') || '').trim();
        if (max === '1' || step === '0.01' || r.id?.toLowerCase().includes('volume')) { vol = r; break; }
      }
      if (!vol && ranges.length === 1) vol = ranges[0];

      // --- ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸€æ—¦è§£é™¤ã—ã¦ã‹ã‚‰å†ãƒã‚¤ãƒ³ãƒ‰ï¼ˆåŒã˜DOMã«ä½•åº¦ã‚‚ä»˜ãã®ã‚’é˜²æ­¢ï¼‰
      if (playBtn) {
        playBtn._bound && playBtn.removeEventListener('click', playBtn._bound);
        playBtn._bound = () => {
          if (!audioEl.src) setLegacyPreviewFromHidden();
          if (audioEl.paused) audioEl.play();
          else audioEl.pause();
        };
        playBtn.addEventListener('click', playBtn._bound);
      }

      if (vol) {
        vol._bound && vol.removeEventListener('input', vol._bound);
        vol._bound = (e) => {
          const v = Number(e.target.value);
          if (!Number.isNaN(v)) { lastVolume = Math.min(1, Math.max(0, v)); audioEl.volume = lastVolume; }
        };
        vol.addEventListener('input', vol._bound);
        // åˆæœŸåæ˜ 
        try { if (typeof vol.value !== 'undefined') vol.value = lastVolume; } catch {}
      }

      // å†ç”ŸçŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’è»½ããƒˆã‚°ãƒ«ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å£Šã•ãªã„ã‚ˆã†æœ€å°é™ï¼‰
      function syncBtnUI(playing) {
        if (!playBtn) return;
        playBtn.dataset.playing = playing ? '1' : '0';
        // æ–‡å­—ãŒã€Œå†ç”Ÿã€ã€Œä¸€æ™‚åœæ­¢ã€ã®å ´åˆã ã‘ãƒˆã‚°ãƒ«ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ç³»ã¯è§¦ã‚‰ãªã„ï¼‰
        const txt = (playBtn.textContent || '').trim();
        if (txt === 'å†ç”Ÿ' && playing) playBtn.textContent = 'ä¸€æ™‚åœæ­¢';
        else if (txt === 'ä¸€æ™‚åœæ­¢' && !playing) playBtn.textContent = 'å†ç”Ÿ';
      }
      audioEl.onplay = () => syncBtnUI(true);
      audioEl.onpause = () => syncBtnUI(false);
      audioEl.onended = () => syncBtnUI(false);
    }

    // `skript.js` å´ã®é¸æŠé–¢æ•°ã«ãƒ•ãƒƒã‚¯ã—ã¦ã€æ›²é¸æŠã®ãŸã³ã«URLã‚’ã‚»ãƒƒãƒˆï¼†UIå†ãƒã‚¤ãƒ³ãƒ‰
    function tryHookSelection(fnName) {
      if (typeof window[fnName] === 'function') {
        const orig = window[fnName];
        window[fnName] = function(...args) {
          const r = orig.apply(this, args);
          setTimeout(() => {
            setLegacyPreviewFromHidden();
            wireLegacyPlayerControls();
          }, 0);
          return r;
        };
      }
    }

    // `#selectedSong` ãŒå·®ã—æ›¿ã‚ã‚‹ãŸã³ã«å†ãƒã‚¤ãƒ³ãƒ‰
    function observeSelectedSong() {
      const tgt = document.getElementById('selectedSong') || document.body;
      const mo = new MutationObserver(() => {
        setLegacyPreviewFromHidden();
        wireLegacyPlayerControls();
      });
      mo.observe(tgt, { childList: true, subtree: true });
    }

    // ------- æ¤œç´¢ã®ä¸¦ã³æ›¿ãˆï¼ˆã‚¯ãƒƒã‚­ãƒ¼ä¿å­˜ â†’ ã‚µãƒ¼ãƒå´ã§ã‚½ãƒ¼ãƒˆé©ç”¨ï¼‰ -------
    function setSearchSortCookie(val) {
      const maxAge = 60*60*24*180; // 180æ—¥
      document.cookie = `searchSort=${encodeURIComponent(val)}; path=/; max-age=${maxAge}`;
    }

    
    async function startRefillCountdown() {
      try {
        const s = await (await fetch("/settings")).json();
        const day = Number(s.refillDay ?? 1);
        const hour = Number(s.refillHour ?? 0);
        const minute = Number(s.refillMinute ?? 0);
        const tz = s.refillTimezone || "Asia/Tokyo";
        const out = document.getElementById("token-countdown");
        if (!out) return;

        function nextRefillEpoch() {
          const now = new Date();
          // JST(+9) only (Asia/Tokyo; no DST)
          const jstNow = new Date(now.getTime() + 9*60*60*1000);
          let y = jstNow.getUTCFullYear();
          let m = jstNow.getUTCMonth() + 1;
          const last = new Date(y, m, 0).getDate();
          const d = Math.min(day, last);
          function build(y,m){ return Date.UTC(y, m-1, d, hour-9, minute, 0); } // UTC epoch
          let target = build(y, m);
          if (now.getTime() >= target) {
            if (m === 12) { y += 1; m = 1; } else { m += 1; }
            const last2 = new Date(y, m, 0).getDate();
            const d2 = Math.min(day, last2);
            target = Date.UTC(y, m-1, d2, hour-9, minute, 0);
          }
          return target;
        }

        function fmtLeft(ms) {
          if (ms <= 0) return "ã¾ã‚‚ãªãé…å¸ƒã•ã‚Œã¾ã™";
          const totalSec = Math.floor(ms/1000);
          const days = Math.floor(totalSec / 86400);
          const hrs = Math.floor((totalSec % 86400) / 3600);
          const mins = Math.floor((totalSec % 3600) / 60);
          const secs = totalSec % 60;
          if (days > 0) return `æ¬¡å›é…å¸ƒã¾ã§: ${days}æ—¥ ${String(hrs).padStart(2,"0")}:${String(mins).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
          return `æ¬¡å›é…å¸ƒã¾ã§: ${String(hrs).padStart(2,"0")}:${String(mins).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
        }

        function tick() {
          const target = nextRefillEpoch();
          const ms = target - Date.now();
          out.textContent = fmtLeft(ms) + " (Asia/Tokyo)";
        }
        tick();
        setInterval(tick, 1000);
      } catch (e) {
        console.warn("countdown init failed:", e);
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      applySettingsToUI();
      ensureRegistered();
      startRefillCountdown();
      refreshAdminTryInfo();

      // ã‚½ãƒ¼ãƒˆé¸æŠã®åˆæœŸåŒ–
      const sel = document.getElementById('searchSort');
      if (sel) {
        const m = document.cookie.match(/(?:^|;\s*)searchSort=([^;]+)/);
        if (m) { try { sel.value = decodeURIComponent(m[1]); } catch {} }
        sel.addEventListener('change', () => {
          setSearchSortCookie(sel.value);
          if (typeof window.searchSongs === 'function') window.searchSongs();
        });
      }

      // é€ä¿¡å¾Œã¯ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('requestForm')?.addEventListener('submit', () => {
        setTimeout(async () => { updateTokenInfo(await fetchMe()); }, 900);
      });

      // ç™»éŒ²
      document.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'registerBtn') registerNow();
      });

      // æ—§UIç”¨ãƒ•ãƒƒã‚¯
      ["selectSong","chooseSong","onSongSelect","applySelection","selectArtist","onPick"].forEach(tryHookSelection);
      observeSelectedSong();
      setLegacyPreviewFromHidden();
      wireLegacyPlayerControls();
    });
  </script>
</body>
</html>
